# Data

## Technical Description

To analyze health status of people living in the United States and its relations with other social, cultural and economic dimensions we use the Annual Social and Economic Supplement to the Current Population Survey (CPS-ASEC from now on). This data is collected annually -mainly during March- by the U.S. Census Bureau and includes information of more than 75,000 households. It is worth noting that the dataset contains information for every member of each of the participating households.

The data is available on the [U.S. Census Bureau's official website](https://www.census.gov/data/datasets/time-series/demo/cps/cps-asec.html) in both SAS and CSV format. As it is documentated in the official [Data Dictionary](https://www2.census.gov/programs-surveys/cps/datasets/2023/march/asec2023_ddl_pub_full.pdf), the variables may refer to three different record types: Household, Family or Person. For this project, we work with a subset of the 'Person Type' variables. Furthermore, as we also want to use georeferencing data, we incorporate the two 'Household Type' variables that point the state and county of every observation. 

There is an available package in R called 'cpsR' [see documentation here](https://cran.r-project.org/web/packages/cpsR/index.html) to import the data. Particularly, there is a function called 'get_asec' to load the data. However, to get the data, we first needed to request a key for the Census API through [this official website](https://api.census.gov/data/key_signup.html). We'll work with the most updated information so far: the 2023 CPS-ASEC dataset.  

The 2023 CPS-ASEC dataset contains information of 146,133 individuals. Each row refers to a unique individual, identified with the variable 'PERIDNUM' (22-digit Unique Person identifier). Since the database is a sample, and logically does not cover the entire population, there is a variable 'A_FNLWGT' that contains the weight associated with each observation. It is important to take this variable into account so that the statistics and graphs are a fair representation of the overall US population. 

There are in total 829 'Person Type' variables in the dataset that cover a huge number of characteristics. For this project, since we are interested in health status and how it relates to specific social, cultural, and economic dimensions we have selected a subset of 10 'Person Type' variables -additionally to the identifier and weight columns-. 

Our main variable is 'HEA' that refers to the health status of the person. This is a categorical variable that takes five possible values: 1 (that accounts for 'Excellent'), 2 ('Very good'), 3 ('Good'), 4 ('Fair') or 5 ('Poor'). We have also chosen two additional variables related to health: 'DIS_HP' and 'NOW_COV': the former indicates if the person has a health problem or a disability that prevents them from working and the latter indicates if the interviewed is currently covered by health insurance coverage. It is worth noting that 'dis_hp' is only available for persons aged at least 15. In addition to these 3 variables related to health, we will also work with 7 other dimensions to better understand how health relates with other metrics. These additional variables are 'A_AGE' (that refers to the age of the person), 'A_SEX' (sex), 'PRDTRACE' (race), 'PEMLR' (employment status), 'A_HGA' (educational attainment), 'PRCITSHP' (citizenship) and 'PEARNVAL' (earnings). Finally, as we have mentioned, we include two 'Household Type' variables: 'GESTFIPS' and 'GTCO' that refer respectively to the state and county in which each person is located. Regarding this point, one issue with the data is that it only covers a subset of about 1300 of the 3100 counties in the United States.

## Research Plan

The main focus of the project is to understand the current health status of the US population. To assess it, we will analyze the variable 'HEA' from the Annual Social and Economic Supplement to the Current Population Survey that indicates the  perception of the self state of health of each interviewed individual. It is worth noting that it is not an objective metric, but rather a subjective one. We will be considering this variable as a proxy of their actual state of health.

In addition, we are interested not only in health status, but also in its relation to other dimensions. For instance, as we pointed out in the Introduction, we wonder whether richer people are healthier -or not- than poorer ones. To understand this relationship, we will study how variables 'HEA' (health status) and 'PEARNVAL' (earnings) interact with each other. Although we will not analyze cause-effect relationships, we will study if these two dimensions are positively or negatively  correlated - or maybe they are not related at all-. From an economic point of view, we should expect a positive relationship since, for example, higher earnings translate into a greater purchasing power to purchase better insurance coverage. However, there may be other factors that mediate this relation. Besides, as 'HEA' is a subjective measure, it could be the case that wealthier people compare their health status to the one of other wealthy people (rather than to the average population) and therefore we may not find a positive relation between economic status and health. To better understand this connection, we will also use the variables 'DIS_HP' and 'NOW_COV' that measure, respectively, if the person has a disability which prevents work, and if the person has currently health insurance coverage.

In a similar way, we are concerning about how employment status relates with health. It is reasonable to believe that employed people enjoy better general health. Indeed, we expect them to have more money and therefore spend more money on health treatments. Nevertheless, it could also be possible that employed people felt more stressed during the day of the interview, and their responses could underestimate their actual health status. We will deepen on this relationship analyzing the variables 'HEA' (health status) and 'PEMLR' (employment status).

Another research question is how the health of native-born or naturalized US citizens relates to that of non-US citizens that live in the US, and how this relation changes with age. To answer this question we will analyze the joint relationship between the variables 'HEA' (health status), 'PRCITSHP' (citizenship) and 'A_AGE' (age). This relationship can take different directions. For instance, it could be the case that nowadays there is no difference in health for young people between US citizens and non-US citizens. However, it is possible that some decades ago, there was a significant difference in health in terms of citizenship status -perhaps due to some health-related legislation- that persists for people who are older today. To answer this type of questions we need to analyze the three different dimensions at the same time -for example, using an adequate mosaic plot-.

We will also use georeferencing data of each person's location to assess whether there are differences in health across states and counties in the United States. In particular, we will utilize the variables 'GESTFIPS' and 'GTCO' that indicate respectively the state and county of each observation. Finally, for all the previous analyses to be correct, we will weigh each observation with its respective weight indicated in the variable 'A_FNLWGT'.

## Initial preprocessing

We first import and load the following packages:
```{r}
#install.packages("cpsR")
#install.packages("usethis")
#install.packages("DataExplorer")
#install.packages("remotes")
#remotes::install_github("jtr13/redav") 
# install.packages("data.table")

library(cpsR)
library(tidyverse)
library(ggplot2)
library(DataExplorer)
library(data.table)
```
Then, we import the selected features from the 2023 CPS-ASEC dataset using the function 'get_asec' from the package 'cpsR':

```{r}
df <- get_asec(year = 2023, vars = c("PERIDNUM", "A_FNLWGT", "GESTFIPS", "GTCO", "HEA", "A_AGE", "A_SEX", "PRCITSHP","PRDTRACE", "PEMLR","A_HGA","PEARNVAL","DIS_HP","NOW_COV"), key="033d6fdb469d970444d91cda781be61fa0d46099", tibble = FALSE)
```

We rename each variable as follows:

```{r}
df <- df %>% 
  rename(
    ID = "peridnum",
    Wt = "a_fnlwgt",
    State = "gestfips",
    Co = "gtco", # County
    Health = "hea",
    Age = "a_age",
    Sex = "a_sex",
    Citz = "prcitshp",
    Race = "prdtrace",
    Empt = "pemlr",
    Edu = "a_hga",
    Earn = "pearnval",
    Pwd = "dis_hp",
    Ins = "now_cov"
    )
```

Since there are certain features whose categories are too detailed for our purposes, we make the following preprocessing:

```{r}
### Sex ###
df$Sex <- factor(df$Sex, levels = c(1, 2), labels = c("Male", "Female"))

### Citizenship ###
df$Citz <- factor(df$Citz, levels = c(1, 2, 3, 4, 5), labels = c("Native", "Native", "Native", "Naturalized", "Not US Citizen"))
# We group:
#     categories 1 (Native, born in the US), 2 (Native, born in PR or US outlying are) and 3 (Native, born abroad of US parent(s)) into "Native". 
#table(df$Citz)

### Employment ###
df$Empt <- factor(df$Empt, levels = c(0, 1, 2, 3, 4, 5, 6, 7), labels = c("NIU","Employed", "Employed", "Unemployed", "Unemployed", "Retired", "Disabled", "Other"))
# We group: 
#     categories 1 (Employed - at work) and 2 (Employed - absent) into "Employed"
#     categories 3 (Unemployed - on layoff) and 4 (Unemployed - looking) into "Unemployed". 
#table(df$Empt)

### Education ###
#table(df$Edu)
df$Edu <- ifelse(df$Edu >= 31 & df$Edu <= 38, 30, df$Edu)
# We group categories 31 to 38 into 30 (than we'll label it as "High school Incomplete")
df$Edu <- factor(df$Edu, levels = c(0, 30, 39, 40, 41, 42, 43, 44, 45, 46), labels = c("Children","High school Incomplete", "High School Complete", "College Incomplete", "Associate", "Associate", "Bachelor", "Master", "Professional Degree", "PHD"))
# We group categories 41 and 42 into "Associate"
#table(df$Edu)

### Race ###
#table(df$Race)
df$Race <- ifelse(df$Race >= 6, 6, df$Race)
df$Race <- factor(df$Race, levels = c(1, 2, 3, 4, 5, 6), labels = c("White","Black", "American Indian", "Asian", "Pacific Islander", "Mixed"))
#table(df$Race)

### Disabled ###
df$Pwd <- factor(df$Pwd, levels = c(0, 1, 2), labels = c("NIU", "Yes", "No"))
#table(df$Pwd)

### Health Status ###
df$Health <- factor(df$Health, levels = c(1, 2, 3, 4, 5), labels = c("Excellent", "Very good", "Good", "Fair", "Poor"))
#table(df$Health)

### Insurance Coverage ###
df$Ins <- factor(df$Ins, levels = c(1, 2), labels = c("Yes", "No"))
```
For instance, we have grouped the categories 1 (Employed - at work) and 2 (Employed - absent) into "Employed" on the feature that indicates the employment status. 

To see the column types: 
```{r}
data.frame(sapply(df,class))
```

Finally, we update the theme of ggplot to center the titles by default:
```{r}
theme_update(plot.title = element_text(hjust = 0.5))
```

## Missing value analysis

Fortunately, there are no missing values for the subset of dimensions of the CPS-ASEC that we will work with. 

Indeed, we can look at this through the following graph:

```{r}
redav::plot_missing(df, percent=TRUE)
```
We have used the 'plot_missing' function from the 'redav' Package. We can see that there are no missing values on any dimension. Indeed, the only row pattern that exists in the dataset is the one that corresponds to 'no missing values', which is named 'complete cases'. It is worth noting that the Census Bureau preprocesses the data and imputes missing values, before releasing the dataset. [(More information about CPS ASEC preprocessing)](https://www.census.gov/newsroom/blogs/research-matters/2019/09/cps-asec.html)

Alternatively, we can draw the following graph:

```{r}
plot_missing_2 <-
function (data, group = list(Good = 0.05, Okay = 0.4, Poor = 0.8, 
  Scarce =  1), geom_label_args = list(), title = NULL, ggtheme = theme_gray(), 
theme_config = list(legend.position = c("bottom"))) 
{
  pct_missing <- Band <- NULL
  missing_value <- data.table(profile_missing(data))
  group <- group[sort.list(unlist(group))]
  invisible(lapply(seq_along(group), function(i) {
    if (i == 1) {
      missing_value[pct_missing <= group[[i]], `:=`(Band,
         names(group)[i])]
    } else {
  missing_value[pct_missing > group[[i - 1]] & pct_missing <= 
     group[[i]], `:=`(Band, names(group)[i])]
    }
}))
  output <- ggplot(missing_value, aes_string(x = "feature", 
    y = "num_missing", fill = "Band")) + geom_bar(stat = "identity") + 
   scale_fill_manual("Band", values = c("Good"="green2","Okay"="gold","Poor"="darkorange","Scarce"="firebrick2")) + coord_flip() + xlab("Features") + 
   ylab("Missing Rows")
  geom_label_args_list <- list(mapping = aes(label = paste0(round(100 * 
    pct_missing, 2), "%")))
  output <- output + do.call("geom_label", c(geom_label_args_list, 
     geom_label_args)) + scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10))
  class(output) <- c("single", class(output))
  plotDataExplorer(plot_obj = output, title = title, ggtheme = ggtheme, 
   theme_config = theme_config)
}


plot_missing_2(df)
```

To create this graph we have used [this adaptation](https://stackoverflow.com/questions/55941265/how-to-change-colors-and-band-labels-in-data-explorers-plot-missing-function) from the 'plot_missing' function from the 'DataExplorer' package. Also, we have added a line of code inside the function to force the y-axis to start at 0. 
The graph indicates the share of rows with missing values for each of the 14 variables. It follows from the graph that  there are no missing values in any of the dimensions. . 

This characteristic of the dataset could also have been discovered through the following code:
```{r}
colSums(is.na(df)) %>% 
  sort (decreasing = TRUE)
```

Although there are no missing values, there are some questions that -by construction- are not asked to certain groups of people. In fact, as it can be checked on the official [Data Dictionary](https://www2.census.gov/programs-surveys/cps/datasets/2023/march/asec2023_ddl_pub_full.pdf), the dimensions 'PEARNVAL' and 'DIS_HP' are only available for people aged at least 15. It makes sense because 'PEARNVAL' refers to the earnings derived from wage or salary, or for self-employment income and 'DIS_HP' indicates whether or not the respondent has a disability that prevents them from working. Indeed, it can be checked that, for instance, the number of people with 'DIS_HP' == "NIU" that stands for "Not in Universe" equals the number of respondents up to 14 years old. 

```{r}
nrow(df[df$Age < 15, ]) == nrow(df[df$Pwd == "NIU", ])
```

# Results

## A first overview

The overall perception of self state of health of people living in the U.S. based on the Annual Social and Economic Supplement (CPS-ASEC) 2023 is as follows:
```{r}
library("ggplot2")
# Perception of Self State of Health in the United States
ggplot(df, mapping=aes(x=fct_rev(Health), weight = Wt/1e6))+
  geom_bar(fill="#1F78B4", alpha=.6, width=.6) + 
  geom_text(stat = "count", aes(label=sprintf("%.1fM", ..count..)), vjust = -0.2, hjust = -0.1, color = "#004080", size = 3, fontface = "bold" ) +   
geom_text(stat = "count", aes(label = sprintf("(%.1f%%)", ..count.. / sum(..count..) * 100)),
            vjust = 1.3, hjust = -0.1, color = "#1F78B4", size = 3, fontface = "bold") +
  coord_flip() +
  scale_y_continuous(labels = scales::comma, limits = c(0, 120)) +
  labs(x = "Health Status",y = "Weighted Frequency (in millions)", caption = "Source: own elaboration for EDAV Final Project based on CPS-ASEC 2023.") + 
  ggtitle("Perception of Self State of Health in the United States") + 
  theme(panel.background = element_rect(fill = "white"))
```
As it was explained in the Data Section, the CPS-ASEC 2023 contains information on 146,133 individuals, so to build the graph for the entire population we use the variable that weights each observation.

The health status category that is most reported is "Very good" with 33.2% of the population, followed by "Excellent" with a share of 28.9% and "Good" with 27%. Combined together, almost 9 out of 10 people report an at least good health status. 

On the contrary, 9 million people (2.7%) suffer a poor health status and 27 million people (8.2%) a fair one.

In the next sections we will study how the self state of health correlates with other dimensions such as employment, earnings, race, education, among others.

## Association between Health and dimensions Race, Sex and Employment

```{r}
library("grid")
library("forcats")
```

```{r}
df_1 <- filter(df, (Race == "White" | Race == "Black" | Race == "Asian") & Empt == "Employed")
df_1 <- df_1 %>% mutate(Health = fct_rev(Health))
df_1$Race <- droplevels(df_1$Race)

vcd::mosaic(
  Health ~ Sex + Race, 
  data = df_1, 
  direction = c("v", "v", "h"), 
  weight = df_1$Wt,  
  highlighting_fill = c("red", "orange", "grey90", "lightgreen","darkgreen"),
  labeling = vcd::labeling_border(
    rot_labels = c(0, 0, 45, 0), 
    gp_labels = gpar(fontsize = 7),  
    gp_varnames = gpar(fontsize = 9, fontface = 2), 
    just_labels = c("center", "right"), 
    rot_varnames = c(0, 0, 0, 0)
  ),
  spacing = vcd::spacing_equal(sp = unit(0.3, "lines")),
  main = "Association for Employed People"
)
```


```{r}
df_2 <- filter(df, (Race == "White" | Race == "Black" | Race == "Asian") & Empt == "Unemployed")
df_2 <- df_2 %>% mutate(Health = fct_rev(Health))
df_2$Race <- droplevels(df_2$Race)

vcd::mosaic(
  Health ~ Sex + Race, 
  data = df_2, 
  direction = c("v", "v", "h"), 
  weight = df_1$Wt,  
  highlighting_fill = c("red", "orange", "grey90", "lightgreen","darkgreen"),
  labeling = vcd::labeling_border(
    rot_labels = c(0, 0, 45, 0), 
    gp_labels = gpar(fontsize = 7),  
    gp_varnames = gpar(fontsize = 9, fontface = 2), 
    just_labels = c("center", "right"), 
    rot_varnames = c(0, 0, 0, 0)
  ),
  spacing = vcd::spacing_equal(sp = unit(0.3, "lines")),
  main = "Association for Unemployed People"
)
```

First, it is worth noting that we have drawn different graphs for employed and unemployed people, since they have different sizes.

For both the employed and unemployed people, we see that the proportion of women that suffers a weak state of health is greater than the proportion of men. For employed people, it is specially more notorious for those that has fair health (i.e., the regions shaded in orange), whereas for unemployed people it is clear for both that suffer a fair or poor health (i.e., the regions shaded in orange and red). 

Regarding the race, for both employed and unemployed people, the proportion of black people that suffers a weak state of health is greater than the proportion corresponding to White or Asian people. Particularly, Asian population seems to have a quite good state of health (for unemployed ones, even better than the health of white people).

Comparing the two graphs, i.e. the population of employed and unemployed people, we see that for all races and sex, the employed people have a better health than the unemployed people which makes sense. In addition, the group of people that has the higher proportion of people with weak health (i.e., fair or poor health) is the black women without employment showing inequalities on health across U.S. people in terms of sex, race and employment status.

In this section we have learned that there appears to be a difference in health status depending on whether a person is currently employed or unemployed. In the next section we focus on those who are employed and study whether there is a difference on health based on earnings.

## How does earnings associate with health?

In this section we analyze how the distribution of earnings of employed people differs based on the health status. 

```{r}
library(ggridges)
filter(df, Empt == "Employed" & Age>=18) %>%
ggplot(df, mapping=aes(x = Earn, y = fct_rev(Health)), weight = Wt/1e6) +
  geom_density_ridges(fill = "blue",alpha = .5, scale = 1) +
  geom_boxplot(pch = 21, width = 0.5, alpha = 0.3) + 
  ggtitle("Distribution of Earnings for Employed People by Health Status") +
  labs(y = "Health", x = "Earnings (in millions)") + 
  scale_x_continuous(labels = scales::comma_format(scale = 1e-6)) 

# The graph would be the same if we order y-axis by the median of earnings y= reorder(Health, Earn, median).
```

The previous graph is quite interesting. First, it shows that the distribution of earnings is right-skewed for every category of health status. In addition, it shows that there seems to be a positive correlation between earnings and health. Indeed, looking at the boxplots, it follows that the both the first quartile (Q1), the median and the third quartile (Q3) of earnings increases with health status. Indeed, for instance the median of people that have an "excellent" -perceived- state of health is higher than the mean of those that have a "very good" state of health, which is in turn higher than the median corresponding to people that have a "good" state of health and so on. In other words, wealthier people enjoys a better state of health than poorer people.

## How does earnings associate with health?


```{r}
# install.packages("weights")
library(weights)

df_3 <- df %>%
  group_by(Citz, Health, Edu) %>%
  mutate(Subtotal = sum(Wt)) %>%
  ungroup() %>%
  group_by(Citz, Health) %>%
  mutate(Total = sum(Wt)) %>%
  ungroup()

df_3 <- df %>%
  group_by(Citz, Health, Edu) %>%
  mutate(Total = sum(Wt)) %>%
  ungroup()

#ggplot(df_3, aes(x = Father, y = Son)) +
 # geom_tile(aes(fill = (Freq/Total)), color = "white") +
  #coord_fixed() + 
  #scale_fill_gradient2(low = "black", mid = "white",
   #                     high = "red", midpoint = .2) +
  #facet_wrap(~Country) + theme_heat

```
